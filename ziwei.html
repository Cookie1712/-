<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´«å¾®æ–—æ•° - ç»ˆæç»Ÿä¸€ç‰ˆ</title>

    <!-- éƒ¨ç½²åˆ° GitHub Pages çš„è¯´æ˜ï¼š
         1. å»ºè®®å°†æœ¬æ–‡ä»¶å‘½åä¸º index.html æ”¾åœ¨ä»“åº“æ ¹ç›®å½•ã€‚
         2. åŒç›®å½•ä¸‹æ”¾ä¸€ä¸ª iztro.min.jsï¼ˆä» https://unpkg.com/iztro@2.5.3/dist/iztro.min.js å¦å­˜ä¸ºå³å¯ï¼‰ã€‚
         3. GitHub Pages çš„ Source æŒ‡å‘è¯¥åˆ†æ”¯ / (root)ï¼Œå³å¯é€šè¿‡ç½‘å€è®¿é—®ã€‚
    -->

    <!-- Tailwind å®˜æ–¹ CDNï¼ˆåªè´Ÿè´£æ ·å¼ï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- æ ¸å¿ƒæ’ç›˜åº“ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œé€‚åˆ GitHub Pages / ç½‘ç»œä¸ç¨³å®šåœºæ™¯ -->
    <script src="./iztro.min.js"></script>
    <!--
    å¦‚æœä½ ä¸æƒ³ä¸‹è½½æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æš‚æ—¶ç”¨çº¿ä¸Š CDNï¼ˆæ³¨æ„ï¼šè®¿é—®ä¸äº† unpkg æ—¶ä¼šå¤±è´¥ï¼‰ï¼š
    <script src="https://unpkg.com/iztro@2.5.3/dist/iztro.min.js"></script>
    -->

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        /* ç»Ÿä¸€çš„ä¸‹æ‹‰æ¡†æ ·å¼ */
        select {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input[type="time"] {
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
            background-color: #fff;
        }
        .pattern-tag {
            background: linear-gradient(to right, #8b5cf6, #6366f1);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            display: inline-block;
            margin-right: 5px;
            margin-bottom: 4px;
            white-space: nowrap;
            cursor: pointer;
        }
        .star-tag {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .star-tag:active {
            transform: scale(0.95);
        }
        .action-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        .loading {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center relative">

    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md overflow-hidden border border-slate-100 z-10">
        <!-- å¤´éƒ¨ -->
        <div class="bg-slate-900 p-6 text-center relative">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-600/30 to-purple-600/30 z-0"></div>
            <h1 class="text-xl font-bold text-white relative z-10">ğŸ”® ç´«å¾®æ–—æ•° Â· ç»Ÿä¸€ç‰ˆ</h1>
            <p class="text-slate-300 text-xs mt-1 relative z-10">v9.0 å®‰å“/iOS å®Œç¾ç»Ÿä¸€ Â· ä¸‹æ‹‰é€‰æ‹©</p>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div class="p-5 space-y-4 bg-slate-50/50">
            <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨ (å¹´/æœˆ/æ—¥) -->
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1.5">å‡ºç”Ÿæ—¥æœŸ (é˜³å†)</label>
                <div class="flex space-x-2">
                    <select id="selYear" class="w-[38%] border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11"></select>
                    <select id="selMonth" class="w-[30%] border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11"></select>
                    <select id="selDay" class="w-[32%] border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11"></select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5">å‡ºç”Ÿæ—¶é—´</label>
                    <input type="time" id="birthTime" value="12:00" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5">æ€§åˆ«</label>
                    <select id="gender" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11">
                        <option value="å¥³">å¥³</option>
                        <option value="ç”·">ç”·</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1.5">å‡ºç”ŸåŸå¸‚</label>
                <input type="text" id="location" placeholder="å¦‚: æ²³å—å‘¨å£" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm h-11">
            </div>

            <button id="calcBtn" onclick="calculate()" class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-indigo-200 text-sm mt-2">
                ğŸš€ å¼€å§‹æ’ç›˜
            </button>
            
            <p id="solarTimeHint" class="text-[10px] text-slate-400 text-center min-h-[15px]"></p>
        </div>

        <!-- ç»“æœåŒº -->
        <div id="resultArea" class="hidden bg-white border-t border-slate-100">
            <div class="p-3 text-center bg-yellow-50 text-yellow-700 text-xs border-b border-yellow-100">
                ğŸ’¡ <strong>å°è´´å£«ï¼š</strong> ç‚¹å‡»ä¸‹æ–¹å½©è‰²çš„æ˜Ÿæ˜ŸæŸ¥çœ‹è§£é‡Š
            </div>
            <div id="forecastContent" class="p-5 space-y-6"></div>
        </div>
    </div>

    <!-- è§£é‡Šå¼¹çª— -->
    <div id="explainModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 relative z-10 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-3">
                <h3 id="modalTitle" class="text-lg font-bold text-slate-800"></h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">âœ•</button>
            </div>
            <p id="modalDesc" class="text-sm text-slate-600 leading-relaxed mb-4"></p>
            <button onclick="closeModal()" class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg text-sm font-bold hover:bg-slate-200">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        // === æ—¥æœŸé€‰æ‹©å™¨é€»è¾‘ (æ–°) ===
        function initDateSelectors() {
            const selYear = document.getElementById('selYear');
            const selMonth = document.getElementById('selMonth');
            const selDay = document.getElementById('selDay');
            const currentYear = new Date().getFullYear();

            // å¡«å……å¹´ä»½ (1930 - å½“å‰å¹´)
            for (let i = currentYear; i >= 1930; i--) {
                selYear.add(new Option(i + 'å¹´', i));
            }
            selYear.value = 1990; // é»˜è®¤é€‰ä¸­1990

            // å¡«å……æœˆä»½
            for (let i = 1; i <= 12; i++) {
                selMonth.add(new Option(i + 'æœˆ', i));
            }

            // æ›´æ–°æ—¥æœŸåˆ—è¡¨
            function updateDays() {
                const y = parseInt(selYear.value);
                const m = parseInt(selMonth.value);
                const daysInMonth = new Date(y, m, 0).getDate();
                const currentDay = selDay.value;
                
                selDay.innerHTML = '';
                for (let i = 1; i <= daysInMonth; i++) {
                    selDay.add(new Option(i + 'æ—¥', i));
                }
                
                // å°è¯•ä¿æŒåŸé€‰ä¸­çš„æ—¥æœŸ
                if (currentDay && currentDay <= daysInMonth) {
                    selDay.value = currentDay;
                }
            }

            selYear.onchange = updateDays;
            selMonth.onchange = updateDays;
            updateDays(); // åˆå§‹åŒ–
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ—¥æœŸæ§ä»¶
        initDateSelectors();

        // å…¨å±€é”™è¯¯æ•è·ï¼ˆæ–¹ä¾¿ä½ åœ¨ GitHub Pages ä¸Šè°ƒè¯•ï¼‰
        window.onerror = function (msg, url, line) {
            alert("å‘ç”Ÿå†…éƒ¨é”™è¯¯ï¼Œè¯·æˆªå›¾å‘ç»™ä½œè€…ï¼š\n" + msg);
            return true;
        };

        // åŸå¸‚ç»åº¦ï¼ˆç”¨äºçœŸå¤ªé˜³æ—¶ä¿®æ­£ï¼‰
        const CITY_LONGITUDES = {
            'åŒ—äº¬': 116.40, 'ä¸Šæµ·': 121.47, 'å¤©æ´¥': 117.20, 'é‡åº†': 106.55,
            'å‘¨å£': 114.65, 'éƒ‘å·': 113.62, 'å¼€å°': 114.30, 'æ´›é˜³': 112.45, 'å¹³é¡¶å±±': 113.19,
            'å®‰é˜³': 114.39, 'æ–°ä¹¡': 113.92, 'è®¸æ˜Œ': 113.85, 'æ¼¯æ²³': 114.01, 'å—é˜³': 112.52,
            'å•†ä¸˜': 115.65, 'ä¿¡é˜³': 114.09, 'é©»é©¬åº—': 114.02,
            'æ­¦æ±‰': 114.31, 'é•¿æ²™': 112.93, 'å¹¿å·': 113.26, 'æ·±åœ³': 114.05, 'æˆéƒ½': 104.06,
            'è¥¿å®‰': 108.93, 'å—äº¬': 118.78, 'æ­å·': 120.15, 'æ²ˆé˜³': 123.43, 'å“ˆå°”æ»¨': 126.63,
            'æµå—': 117.02, 'é¦™æ¸¯': 114.16, 'å°åŒ—': 121.50, 'æ²³å—': 113.62
        };

        const STAR_WIKI = {
            'åŒ–ç¦„': 'ã€è´¢å¯Œ/æƒ…ç¼˜ã€‘äº‹äº‹é¡ºé‚ï¼Œå¿ƒæƒ…æ„‰å¿«ï¼Œåƒç§‹å¤©çš„æ”¶è·ã€‚',
            'åŒ–æƒ': 'ã€æƒåŠ›/æ§åˆ¶ã€‘æŒæƒå‡èŒï¼Œæœ‰è¡ŒåŠ¨åŠ›ï¼Œä½†ä¹Ÿå®¹æ˜“å›ºæ‰§éœ¸é“ã€‚',
            'åŒ–ç§‘': 'ã€åå£°/è´µäººã€‘åæ°”æå‡ï¼Œè€ƒè¿å¥½ï¼Œæœ‰äººèµè¯†ï¼Œé€¢å‡¶åŒ–å‰ã€‚',
            'åŒ–å¿Œ': 'ã€é˜»ç¢/çº ç»“ã€‘ä¸é¡ºå¿ƒï¼ŒäºæŸï¼Œå£èˆŒäº‰æ‰§ï¼Œæˆ–è€…å¿ƒé‡Œæƒ³ä¸å¼€ã€‚',
            'ç¦„å­˜': 'ã€å­˜æ¬¾/çœŸè´¢ã€‘å®æ‰“å®çš„é’±è´¢ç§¯è“„ï¼Œåšäº‹ç¨³é‡ã€‚',
            'å¤©é©¬': 'ã€å¥”æ³¢/å˜åŠ¨ã€‘å‡ºå·®ã€æ—…æ¸¸ã€è·³æ§½ã€‚è¶ŠåŠ¨è¶Šæœ‰æœºä¼šã€‚',
            'å·¦è¾…': 'ã€å¹³è¾ˆè´µäººã€‘æœ‹å‹åŒäº‹å¸®å¿™ï¼Œæ•ˆç‡åŠ å€ã€‚',
            'å³å¼¼': 'ã€å¼‚æ€§è´µäººã€‘è·å¾—é¢å¤–çš„å¸®åŠ©æˆ–èµ„æºã€‚',
            'å¤©é­': 'ã€é•¿è¾ˆææ‹”ã€‘ä¸Šå¸ç»™æœºä¼šï¼Œç›´æ¥çš„å¸®åŠ©ã€‚',
            'å¤©é’º': 'ã€æš—ä¸­ç›¸åŠ©ã€‘æœ‰äººåœ¨èƒŒåè¯´å¥½è¯ï¼Œé—´æ¥çš„æœºé‡ã€‚',
            'æ“ç¾Š': 'ã€åˆ‘ä¼¤/å†²åŠ¨ã€‘åƒæŠŠåˆ€ã€‚å®¹æ˜“å—ä¼¤ã€æ‰‹æœ¯ã€å†²çªï¼Œä½†ä¹Ÿé€‚åˆå¼€æ‹“ã€‚',
            'é™€ç½—': 'ã€æ‹–å»¶/çº ç»“ã€‘åƒé™€èºåŸåœ°è½¬ã€‚è¿›å±•æ…¢ï¼Œå†…å¿ƒçº ç»“ï¼Œæœ‰é˜»ç¢ã€‚',
            'ç«æ˜Ÿ': 'ã€çˆ†å‘/ç«çˆ†ã€‘çªå‘äº‹ä»¶ã€‚å¥½çš„æ—¶å€™å‘æ¨ªè´¢ï¼Œåçš„æ—¶å€™å‘è„¾æ°”ã€‚',
            'é“ƒæ˜Ÿ': 'ã€æš—äº/éšå¿ã€‘çœ‹ä¸è§çš„æŸå¤±ï¼Œåƒå“‘å·´äºï¼Œå¿ƒé‡Œæ†‹å±ˆã€‚',
            'åœ°ç©º': 'ã€è½ç©º/åˆ›æ„ã€‘å¾—è€Œå¤å¤±ï¼Œé’±èŠ±å¾—è«åå…¶å¦™ã€‚åˆ©äºä¿®è¡Œåˆ›æ„ã€‚',
            'åœ°åŠ«': 'ã€åŠ«è´¢/æŸå¤±ã€‘åŠé€”è€ŒåºŸï¼Œè¢«äººæˆªèƒ¡ï¼Œå°å¿ƒé’±åŒ…ã€‚',
            'æ–‡æ˜Œ': 'ã€æ–‡ä¹¦/æ­£é€”ã€‘åˆ©äºè€ƒè¯•ã€åˆåŒã€æ­£è§„é€”å¾„çš„å‘å±•ã€‚',
            'æ–‡æ›²': 'ã€æ‰è‰º/å£æ‰ã€‘åˆ©äºæ¼”è®²ã€è‰ºæœ¯ã€åˆ›æ„ã€æ¡ƒèŠ±ã€‚',
            'å·¨é—¨': 'ã€å£èˆŒ/æ²Ÿé€šã€‘æ˜¯éå¤šï¼Œæ˜“æœ‰è¯¯ä¼šï¼Œä¹Ÿé€‚åˆé å˜´åƒé¥­ã€‚',
            'è´ªç‹¼': 'ã€æ¬²æœ›/äº¤é™…ã€‘åº”é…¬å¤šï¼Œæ¡ƒèŠ±æ—ºï¼Œåƒå–ç©ä¹æœºä¼šå¤šã€‚'
        };

        const ACTION_GUIDE = {
            'åŒ–ç¦„': { yi: ['è°ˆè–ªèµ„', 'è¯·å®¢', 'æŠ•èµ„'], ji: ['é“ºå¼ ', 'æµªè´¹'] },
            'åŒ–æƒ': { yi: ['å‡èŒ', 'ç®¡ç†', 'æ‰§è¡Œ'], ji: ['åˆšæ„', 'æ ‘æ•Œ'] },
            'åŒ–ç§‘': { yi: ['è€ƒè¯•', 'å‘è¡¨', 'æ±‚åŒ»'], ji: ['ä½œå¼Š', 'éšç’'] },
            'åŒ–å¿Œ': { yi: ['è¯»ä¹¦', 'åçœ', 'è¿˜å€º'], ji: ['ç­¾çº¦', 'äº‰æ‰§', 'å¼€æ‹“'] },
            'ç¦„å­˜': { yi: ['å­˜é’±', 'ä¿é™©', 'ç¨³å¥'], ji: ['å€Ÿè´·', 'æ‹…ä¿'] },
            'å¤©é©¬': { yi: ['å‡ºå·®', 'æ¬å®¶', 'è·‘åŠ¨'], ji: ['å®…å®¶', 'å®ˆæ—§'] },
            'å¤©é­': { yi: ['æ‹œè®¿', 'æ±‚èŒ', 'æé—®'], ji: ['å‚²æ…¢', 'æ‹’ç»'] },
            'å¤©é’º': { yi: ['ç¤¾äº¤', 'ç›¸äº²', 'åˆä½œ'], ji: ['å°é—­', 'é©¬è™'] },
            'æ–‡æ˜Œ': { yi: ['ç­¾çº¦', 'è€ƒè¯•', 'æ–‡ä¹¦'], ji: ['ç²—å¿ƒ', 'æ‹…ä¿'] },
            'æ–‡æ›²': { yi: ['åˆ›æ„', 'æ¼”è®²', 'è¡¨ç™½'], ji: ['æ»¥æƒ…', 'è¯ˆéª—'] },
            'æ“ç¾Š': { yi: ['æ´—ç‰™', 'å¥èº«', 'çœ‹ç‰™'], ji: ['é£™è½¦', 'å†’é™©', 'æ‰“æ¶'] },
            'é™€ç½—': { yi: ['é’»ç ”', 'æ…¢æ´»', 'å†¥æƒ³'], ji: ['æ€¥èº', 'å†³æ–­'] },
            'ç«æ˜Ÿ': { yi: ['é€Ÿå†³', 'å½©ç¥¨', 'æ€¥äº‹'], ji: ['å‘ç«', 'ç©ç«', 'æ‹–å»¶'] },
            'é“ƒæ˜Ÿ': { yi: ['å’¨è¯¢', 'éŸ³ä¹', 'æ€è€ƒ'], ji: ['ç”Ÿé—·æ°”', 'ç®—è®¡'] },
            'åœ°ç©º': { yi: ['ç„å­¦', 'åˆ›æ„', 'æ–­èˆç¦»'], ji: ['æŠ•èµ„', 'è´­ç‰©'] },
            'åœ°åŠ«': { yi: ['ææ¬¾', 'ç ´è´¢', 'æ¸…ç†'], ji: ['åˆä¼™', 'å€Ÿå‡º'] },
            'å·¨é—¨': { yi: ['æ¼”è®²', 'çœ‹ç‰™', 'ç¾é£Ÿ'], ji: ['å…«å¦', 'ä¹±è¯´'] },
            'è´ªç‹¼': { yi: ['åº”é…¬', 'ç¾å®¹', 'æ‰è‰º'], ji: ['çƒ‚æ¡ƒèŠ±', 'æš´é£Ÿ'] }
        };

        const PATTERNS = [
            { name: 'ç«è´ªæ ¼', check: (stars) => stars.has('è´ªç‹¼') && (stars.has('ç«æ˜Ÿ') || stars.has('é“ƒæ˜Ÿ')), score: 5, desc: 'ğŸ”¥ ç«è´ªæ ¼ï¼šçˆ†å‘è¿ï¼Œåˆ©äºçªå‘æ¨ªè´¢' },
            { name: 'ç¦„é©¬äº¤é©°', check: (stars) => (stars.has('ç¦„å­˜') || stars.has('åŒ–ç¦„')) && stars.has('å¤©é©¬'), score: 4, desc: 'ğŸ ç¦„é©¬äº¤é©°ï¼šåŠ¨ä¸­æ±‚è´¢ï¼Œè¶Šå¿™è¶Šæœ‰é’±' },
            { name: 'é˜³æ¢æ˜Œç¦„', check: (stars) => stars.has('å¤ªé˜³') && stars.has('å¤©æ¢') && stars.has('æ–‡æ˜Œ') && stars.has('ç¦„å­˜'), score: 5, desc: 'ğŸ“š é˜³æ¢æ˜Œç¦„ï¼šè€ƒè¿äº¨é€šï¼Œåˆ©äºè€ƒè¯•' },
            { name: 'ç©ºåŠ«å¤¹/ç…§', check: (stars) => stars.has('åœ°ç©º') && stars.has('åœ°åŠ«'), score: -4, desc: 'ğŸŒªï¸ ç©ºåŠ«åŒä¸´ï¼šè´¢æ¥è´¢å»ï¼Œå®œä¿®èº«å…»æ€§' },
            { name: 'å·¨ç«ç¾Š', check: (stars) => stars.has('å·¨é—¨') && stars.has('ç«æ˜Ÿ') && stars.has('æ“ç¾Š'), score: -5, desc: 'âš¡ å·¨ç«ç¾Šï¼šé˜²é‡å¤§å£èˆŒå†²çªã€æ„å¤–' },
            { name: 'åˆ‘å¿Œå¤¹å°', check: (stars) => stars.has('å¤©ç›¸') && stars.has('åŒ–å¿Œ') && stars.has('æ“ç¾Š'), score: -4, desc: 'ğŸ“œ åˆ‘å¿Œå¤¹å°ï¼šå°å¿ƒæ–‡ä¹¦åˆåŒé™·é˜±' },
            { name: 'ç¦„é€¢å†²ç ´', check: (stars) => (stars.has('åŒ–ç¦„') || stars.has('ç¦„å­˜')) && (stars.has('åœ°ç©º') || stars.has('åœ°åŠ«') || stars.has('åŒ–å¿Œ')), score: -3, desc: 'ğŸ’¸ ç¦„é€¢å†²ç ´ï¼šçœ‹ç€èµšé’±å®é™…èµ”é’±' }
        ];

        function showExplain(name) {
            let key = name;
            let desc = STAR_WIKI[key];
            if (!desc) {
                if (name.includes('åŒ–ç¦„')) key = 'åŒ–ç¦„';
                else if (name.includes('åŒ–æƒ')) key = 'åŒ–æƒ';
                else if (name.includes('åŒ–ç§‘')) key = 'åŒ–ç§‘';
                else if (name.includes('åŒ–å¿Œ')) key = 'åŒ–å¿Œ';
                desc = STAR_WIKI[key];
            }
            if (!desc) return;
            document.getElementById('modalTitle').innerText = key;
            document.getElementById('modalDesc').innerText = desc;
            const modal = document.getElementById('explainModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.style.opacity = '1';
                content.style.transform = 'scale(1)';
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('explainModal');
            const content = document.getElementById('modalContent');
            content.style.opacity = '0';
            content.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function getSolarOffset(locationName) {
            let longitude = 120;
            for (let city in CITY_LONGITUDES) {
                if (locationName.includes(city)) {
                    longitude = CITY_LONGITUDES[city];
                    break;
                }
            }
            return (longitude - 120) * 4; // æ¯åº¦ 4 åˆ†é’Ÿ
        }

        function getTrueSolarTimeIndex(dateStr, timeStr, offsetMinutes) {
            const dt = new Date(`${dateStr}T${timeStr}:00`);
            dt.setMinutes(dt.getMinutes() + offsetMinutes);
            const h = dt.getHours();
            let index = Math.floor((h + 1) / 2);
            if (index >= 12) index = 0;
            const fixedTimeStr = `${String(h).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`;
            return { index, fixedTimeStr };
        }

        async function calculate() {
            const btn = document.getElementById('calcBtn');

            // å…³é”®ï¼šåœ¨ GitHub Pages ä¸Šï¼Œå¦‚æœ iztro.min.js æ²¡åŠ è½½åˆ°ï¼Œè¿™é‡Œä¼šç›´æ¥æç¤º
            if (typeof iztro === 'undefined') {
                alert("âš ï¸ ç®—æ³•åº“åŠ è½½å¤±è´¥ï¼š\n\n1ï¼‰è¯·ç¡®è®¤å’Œ index.html åŒç›®å½•ä¸‹æœ‰ iztro.min.jsï¼›\n2ï¼‰æˆ–è€…æ”¹ç”¨è„šæœ¬æ ‡ç­¾é‡Œçš„ CDN ç‰ˆæœ¬ã€‚");
                return;
            }

            // è·å–è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨çš„å€¼
            const y = document.getElementById('selYear').value;
            const m = document.getElementById('selMonth').value.padStart(2, '0');
            const d = document.getElementById('selDay').value.padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;

            const timeStr = document.getElementById('birthTime').value;
            const location = document.getElementById('location').value || '';
            const genderVal = document.getElementById('gender').value;
            const resultArea = document.getElementById('resultArea');
            const content = document.getElementById('forecastContent');
            const hint = document.getElementById('solarTimeHint');

            if (!timeStr) {
                alert("è¯·é€‰æ‹©å‡ºç”Ÿæ—¶é—´ï¼");
                return;
            }

            btn.innerText = "ğŸ”„ æ­£åœ¨ç²¾å¯†æ¨æ¼”...";
            btn.disabled = true;
            btn.classList.add('bg-gray-400');

            setTimeout(() => {
                try {
                    const offset = getSolarOffset(location);
                    const { index: timeIndex, fixedTimeStr } = getTrueSolarTimeIndex(dateStr, timeStr, offset);
                    hint.textContent =
                        Math.abs(offset) > 1
                            ? `*çœŸå¤ªé˜³æ—¶: ${fixedTimeStr} (åå·®${Math.round(offset)}åˆ†)`
                            : `*ä½¿ç”¨æ ‡å‡†æ—¶é—´`;

                    const gender = genderVal === 'ç”·' ? 'ç”·' : 'å¥³';

                    // æ ¸å¿ƒæ’ç›˜
                    const astrolabe = iztro.astro.bySolar(dateStr, timeIndex, gender, true, 'zh-CN');

                    content.innerHTML = '';
                    const today = new Date();
                    // ç”Ÿæˆæœªæ¥ 3 ä¸ªæœˆçš„è¿åŠ¿
                    for (let i = 0; i < 3; i++) {
                        let targetDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        const targetStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-15 12:00:00`;
                        content.innerHTML += generateDeepAnalysis(astrolabe, targetDate, targetStr);
                    }

                    resultArea.classList.remove('hidden');
                    setTimeout(() => {
                        resultArea.scrollIntoView({ behavior: "smooth", block: "start" });
                    }, 100);

                } catch (e) {
                    alert("âŒ å‡ºé”™äº†ï¼š\n" + e.message);
                } finally {
                    btn.innerText = "ğŸš€ å¼€å§‹æ’ç›˜";
                    btn.disabled = false;
                    btn.classList.remove('bg-gray-400');
                }
            }, 100);
        }

        function getStarSetAndList(astrolabe, scope) {
            const monthIndex = scope.monthly.index;
            const indices = [monthIndex, (monthIndex + 6) % 12, (monthIndex + 4) % 12, (monthIndex + 8) % 12];
            let starSet = new Set(),
                starList = [];
            indices.forEach((idx, i) => {
                const p = astrolabe.palace(idx);
                const majors = p.majorStars || [];
                const minors = p.minorStars || [];
                [...majors, ...minors].forEach((s) => {
                    starSet.add(s.name);
                    starList.push({ name: s.name, src: i === 0 ? 'æœ¬å®«' : 'ä¸‰æ–¹', type: 'static' });
                });
            });
            const mutagens = scope.monthly.mutagens || [];
            mutagens.forEach((m) => {
                starSet.add(m.name + m.mutagen);
                starSet.add(m.mutagen);
                starSet.add(m.name);
                starList.push({ name: m.name + m.mutagen, src: 'æµå˜', type: 'mutagen' });
            });
            return { starSet, starList };
        }

        function getAdvice(starList) {
            let yiList = new Set(),
                jiList = new Set(),
                hasAdvice = false;
            starList.forEach((s) => {
                let key = s.name;
                if (s.name.includes('åŒ–ç¦„')) key = 'åŒ–ç¦„';
                else if (s.name.includes('åŒ–æƒ')) key = 'åŒ–æƒ';
                else if (s.name.includes('åŒ–ç§‘')) key = 'åŒ–ç§‘';
                else if (s.name.includes('åŒ–å¿Œ')) key = 'åŒ–å¿Œ';
                const guide = ACTION_GUIDE[key];
                if (guide) {
                    guide.yi.forEach((i) => yiList.add(i));
                    guide.ji.forEach((i) => jiList.add(i));
                    hasAdvice = true;
                }
            });
            if (!hasAdvice) {
                yiList.add('æŒ‰éƒ¨å°±ç­');
                yiList.add('ä¿æŒå¹³å¸¸å¿ƒ');
                jiList.add('æ€¥èºå†’è¿›');
                jiList.add('ç†¬å¤œ');
            }
            return { yi: Array.from(yiList).slice(0, 4), ji: Array.from(jiList).slice(0, 4) };
        }

        function generateDeepAnalysis(astrolabe, dateObj, dateStr) {
            const scope = astrolabe.horoscope(dateStr);
            if (!scope || !scope.monthly) return '';
            const monthIndex = scope.monthly.index;
            const palaceName = astrolabe.palace(monthIndex).name;
            const { starSet, starList } = getStarSetAndList(astrolabe, scope);
            const lunarStr = scope.lunarDate ? scope.lunarDate.toString() : '';
            let lunarShort = "å†œå†æœˆä»½";
            if (lunarStr) {
                const match = lunarStr.match(/[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æœˆ/);
                if (match) lunarShort = "å†œå†" + match[0];
            }

            let matchedPatterns = [];
            PATTERNS.forEach((p) => {
                if (p.check(starSet)) matchedPatterns.push(p);
            });

            let totalScore = 0;
            matchedPatterns.forEach((p) => (totalScore += p.score));
            starList.forEach((s) => {
                if (s.name.includes('åŒ–ç¦„') || s.name.includes('åŒ–æƒ') || s.name.includes('åŒ–ç§‘')) totalScore += 1;
                if (s.name.includes('åŒ–å¿Œ')) totalScore -= 1.5;
                if (['å·¦è¾…', 'å³å¼¼', 'å¤©é­', 'å¤©é’º', 'ç¦„å­˜'].includes(s.name)) totalScore += 1;
                if (['æ“ç¾Š', 'é™€ç½—', 'ç«æ˜Ÿ', 'é“ƒæ˜Ÿ', 'åœ°ç©º', 'åœ°åŠ«'].includes(s.name)) totalScore -= 1.5;
            });

            let summaryTitle = "",
                summaryColor = "";
            if (totalScore >= 5) {
                summaryTitle = "ğŸš€ è¿åŠ¿å¼ºåŠ²";
                summaryColor = "text-emerald-600";
            } else if (totalScore >= 2) {
                summaryTitle = "ğŸ“ˆ ç¨³ä¸­å‘å¥½";
                summaryColor = "text-blue-600";
            } else if (totalScore >= -2) {
                summaryTitle = "âš–ï¸ å¹³ç¨³è¿‡æ¸¡";
                summaryColor = "text-slate-600";
            } else if (totalScore >= -6) {
                summaryTitle = "ğŸŒªï¸ é˜»åŠ›æ˜¾ç°";
                summaryColor = "text-orange-600";
            } else {
                summaryTitle = "ğŸ›‘ ä¸¥é˜µä»¥å¾…";
                summaryColor = "text-red-600";
            }

            const advice = getAdvice(starList);

            return `
                <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm mb-4">
                    <div class="flex justify-between items-start border-b border-slate-100 pb-3 mb-3">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ</h3>
                            <div class="text-xs text-slate-500 mt-0.5 flex items-center">
                                <span class="bg-slate-100 px-1.5 py-0.5 rounded mr-2">${lunarShort}</span>
                                <span>æµæœˆåœ¨ã€${palaceName}ã€‘</span>
                            </div>
                        </div>
                        <div class="text-right mt-1">
                            <span class="text-sm font-bold ${summaryColor}">${summaryTitle}</span>
                        </div>
                    </div>
                    ${
                        matchedPatterns.length > 0
                            ? `<div class="mb-3 bg-indigo-50 rounded-lg p-2.5 border border-indigo-100">
                                   <div class="space-y-2">
                                       ${matchedPatterns
                                           .map(
                                               (p) => `
                                           <div class="flex flex-col" onclick="showExplain('${p.name}')">
                                               <div class="flex items-center">
                                                   <span class="pattern-tag">æ ¼å±€</span>
                                                   <span class="text-xs font-bold text-indigo-900 underline decoration-dotted">${p.name}</span>
                                               </div>
                                               <span class="text-xs text-slate-600 pl-1">${p.desc.split('ï¼š')[1]}</span>
                                           </div>
                                       `
                                           )
                                           .join('')}
                                   </div>
                               </div>`
                            : ''
                    }
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="bg-emerald-50/50 p-2 rounded-lg">
                            <h4 class="text-[10px] font-bold text-emerald-600 mb-1.5 uppercase">å‰è±¡ (ç‚¹å‡»æŸ¥çœ‹)</h4>
                            <div class="flex flex-wrap gap-1.5">
                                ${getStarTags(starList, 'good') || '<span class="text-[10px] text-slate-300">æ— æ˜æ˜¾å‰æ˜Ÿ</span>'}
                            </div>
                        </div>
                        <div class="bg-rose-50/50 p-2 rounded-lg">
                            <h4 class="text-[10px] font-bold text-rose-600 mb-1.5 uppercase">å‡¶è±¡ (ç‚¹å‡»æŸ¥çœ‹)</h4>
                            <div class="flex flex-wrap gap-1.5">
                                ${getStarTags(starList, 'bad') || '<span class="text-[10px] text-slate-300">æ— æ˜æ˜¾ç…æ˜Ÿ</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-100 grid grid-cols-1 gap-2">
                        <div class="flex items-start">
                            <span class="text-xs font-bold text-emerald-600 mr-2 mt-0.5 shrink-0">âœ… å®œï¼š</span>
                            <div class="flex flex-wrap gap-1">
                                ${advice.yi
                                    .map((t) => `<span class="action-badge bg-emerald-100 text-emerald-700">${t}</span>`)
                                    .join('')}
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="text-xs font-bold text-rose-600 mr-2 mt-0.5 shrink-0">âŒ å¿Œï¼š</span>
                            <div class="flex flex-wrap gap-1">
                                ${advice.ji
                                    .map((t) => `<span class="action-badge bg-rose-100 text-rose-700">${t}</span>`)
                                    .join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStarTags(list, type) {
            let filtered = [],
                seen = new Set();
            const BASE_DESC = {
                'åŒ–ç¦„': 'good',
                'åŒ–æƒ': 'good',
                'åŒ–ç§‘': 'good',
                'åŒ–å¿Œ': 'bad',
                'ç¦„å­˜': 'good',
                'å¤©é©¬': 'good',
                'å·¦è¾…': 'good',
                'å³å¼¼': 'good',
                'å¤©é­': 'good',
                'å¤©é’º': 'good',
                'æ“ç¾Š': 'bad',
                'é™€ç½—': 'bad',
                'ç«æ˜Ÿ': 'bad',
                'é“ƒæ˜Ÿ': 'bad',
                'åœ°ç©º': 'bad',
                'åœ°åŠ«': 'bad'
            };
            list.forEach((s) => {
                let starType = '';
                if (s.name.includes('åŒ–ç¦„') || s.name.includes('åŒ–æƒ') || s.name.includes('åŒ–ç§‘')) starType = 'good';
                else if (s.name.includes('åŒ–å¿Œ')) starType = 'bad';
                else {
                    let key = Object.keys(BASE_DESC).find((k) => s.name.includes(k));
                    if (key) starType = BASE_DESC[key];
                }
                if (type === 'good' && starType === 'good' && !seen.has(s.name)) {
                    filtered.push(
                        `<span class="star-tag px-1.5 py-0.5 bg-white border border-emerald-100 text-emerald-700 rounded text-[10px] font-medium shadow-sm" onclick="showExplain('${s.name}')">${s.name}</span>`
                    );
                    seen.add(s.name);
                }
                if (type === 'bad' && starType === 'bad' && !seen.has(s.name)) {
                    filtered.push(
                        `<span class="star-tag px-1.5 py-0.5 bg-white border border-rose-100 text-rose-700 rounded text-[10px] font-medium shadow-sm" onclick="showExplain('${s.name}')">${s.name}</span>`
                    );
                    seen.add(s.name);
                }
            });
            return filtered.join('');
        }
    </script>
</body>
</html>
