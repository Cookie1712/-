<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç„å­¦ - ä¸ªäººè¿åŠ¿ä¸­å¿ƒ (v11.1 è¯¦è§£ç‰ˆ)</title>

    <!-- å…³é”®ä¿®å¤ï¼šä½¿ç”¨æµè§ˆå™¨ç‰ˆ Tailwind CDNï¼Œè€Œä¸æ˜¯ npm.elemecdn çš„æ„å»ºåŒ… -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- æœ¬åœ° lunar åº“ + CDN å…œåº• -->
    <script src="./lunar.js"></script>
    <script>
        if (typeof Lunar === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.7.7/lunar.min.js"><\/script>');
        }
    </script>

    <!-- æœ¬åœ° iztro åº“ + CDN å…œåº• -->
    <script src="./iztro.min.js"></script>
    <script>
        if (typeof iztro === 'undefined') {
            document.write('<script src="https://npm.elemecdn.com/iztro@2.6.3/dist/iztro.min.js"><\/script>');
        }
    </script>

    <style>
        body {
            font-family: -apple-system, "Microsoft YaHei", sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .tab-btn {
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            opacity: 0.6;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            opacity: 1;
            font-weight: bold;
        }
        select {
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-10 bg-slate-100">

    <!-- é¡¶éƒ¨ Tab -->
    <div class="sticky top-0 z-50 w-full max-w-md bg-white shadow-sm">
        <div class="flex text-center">
            <div onclick="switchTab('daily')" id="btn-daily"
                 class="tab-btn active flex-1 py-3 cursor-pointer text-sm">ğŸ—“ï¸ ä»Šæ—¥è¿åŠ¿</div>
            <div onclick="switchTab('ziwei')" id="btn-ziwei"
                 class="tab-btn flex-1 py-3 cursor-pointer text-sm">ğŸ”® ç´«å¾®æµæœˆ</div>
        </div>
    </div>

    <div class="w-full max-w-md px-4 py-4 space-y-4">

        <!-- ä¸ªäººä¿¡æ¯ -->
        <div class="bg-white rounded-2xl shadow-sm p-5 border border-indigo-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-bold text-slate-700 border-l-4 border-indigo-500 pl-2">ä¸ªäººä¿¡æ¯</h2>
                <button onclick="calculateAll()"
                        class="bg-indigo-600 text-white text-xs px-3 py-1.5 rounded-lg active:scale-95 transition shadow-md">
                    ğŸ”„ é‡æ–°æµ‹ç®—
                </button>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <select id="selYear"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                <select id="selMonth"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
                <select id="selDay"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none"></select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="time" id="birthTime" value="12:00"
                       class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none">
                <select id="gender"
                        class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none">
                    <option value="å¥³">å¥³</option>
                    <option value="ç”·">ç”·</option>
                </select>
            </div>
            <input type="text" id="location" placeholder="å‡ºç”Ÿåœ° (å¦‚: æµ·å—)"
                   class="mt-2 w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm outline-none">
        </div>

        <!-- ä»Šæ—¥è¿åŠ¿é¡µ -->
        <div id="view-daily" class="fade-in space-y-4">
            <!-- é¡¶éƒ¨å¡ç‰‡ -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="text-3xl font-bold tracking-tight" id="dailyDate">--</div>
                        <div class="text-sm text-slate-300 mt-1" id="dailyLunar">æ­£åœ¨åŠ è½½...</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-amber-400" id="dailyGanzhi">--</div>
                        <div class="text-[10px] border border-slate-500 px-1.5 rounded mt-1 inline-block text-slate-400"
                             id="dailyNayin">--</div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-white/10 flex justify-between items-center">
                    <span class="text-xs text-slate-400">ä½ çš„å…«å­—æ—¥ä¸»</span>
                    <span class="text-sm font-bold bg-white/20 px-2 py-0.5 rounded"
                          id="userDayMaster">è®¡ç®—ä¸­...</span>
                </div>
            </div>

            <!-- å¹¸è¿è‰² / å¼€è¿ç‰© -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex flex-col items-center justify-center">
                    <div class="text-xs text-slate-400 font-bold mb-2 uppercase">ä»Šæ—¥å¹¸è¿è‰²</div>
                    <div id="luckyColorDot"
                         class="w-12 h-12 rounded-full shadow-inner border-4 border-white ring-1 ring-slate-200 bg-slate-200 mb-1"></div>
                    <div class="font-bold text-slate-700" id="luckyColorText">--</div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex flex-col items-center justify-center">
                    <div class="text-xs text-slate-400 font-bold mb-2 uppercase">å¼€è¿å°ç‰©</div>
                    <div class="text-3xl mb-1" id="luckyItemIcon">â“</div>
                    <div class="font-bold text-slate-700" id="luckyItemText">--</div>
                </div>
            </div>

            <!-- è€é»„å† -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center">
                    <span class="mr-2">ğŸ“œ</span> è€é»„å†å®œå¿Œ
                </h3>
                <div class="space-y-3">
                    <div class="flex items-start">
                        <span class="bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded shrink-0 mr-2 mt-0.5">
                            å®œ
                        </span>
                        <div class="flex flex-wrap gap-1.5" id="almanac-yi">--</div>
                    </div>
                    <div class="flex items-start">
                        <span class="bg-rose-100 text-rose-700 text-xs font-bold px-2 py-1 rounded shrink-0 mr-2 mt-0.5">
                            å¿Œ
                        </span>
                        <div class="flex flex-wrap gap-1.5" id="almanac-ji">--</div>
                    </div>
                </div>
            </div>

            <!-- æ˜“ç»å€¼æ—¥å¦ -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center">
                    <span class="mr-2">â˜¯ï¸</span> æ˜“ç»å€¼æ—¥å¦
                </h3>
                <div class="bg-slate-50 rounded-xl p-4 flex gap-4 items-center">
                    <div id="gua-lines" class="w-10 flex flex-col-reverse gap-[2px]"></div>
                    <div>
                        <div class="font-bold text-lg text-slate-800" id="gua-name">--</div>
                        <div class="text-xs text-slate-500 leading-relaxed mt-1" id="gua-desc">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç´«å¾®æµæœˆé¡µ -->
        <div id="view-ziwei" class="hidden fade-in space-y-4">
            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 text-center">
                <p class="text-indigo-800 font-bold text-sm">ğŸ”® æœªæ¥ä¸‰ä¸ªæœˆæµæœˆè¿åŠ¿è¯¦è§£</p>
                <p class="text-[10px] text-indigo-500 mt-1">ç»“åˆä¸‰æ–¹å››æ­£ Â· æ™ºèƒ½ç”Ÿæˆæ–­è¯­</p>
            </div>
            <div id="ziwei-result" class="space-y-4"></div>
        </div>
    </div>

    <!-- æ˜Ÿæ›œè§£é‡Šå¼¹çª— -->
    <div id="explainModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 relative z-10 transform transition-all scale-95">
            <h3 id="modalTitle" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <p id="modalDesc" class="text-sm text-slate-600 leading-relaxed mb-4"></p>
            <button onclick="closeModal()"
                    class="w-full bg-slate-100 text-slate-700 py-2 rounded-lg text-sm font-bold">
                å…³é—­
            </button>
        </div>
    </div>

    <script>
        const CITY_LONGITUDES = {
            'åŒ—äº¬':116.40,'ä¸Šæµ·':121.47,'å¹¿å·':113.26,'æ·±åœ³':114.05,
            'æµ·å£':110.32,'å‘¨å£':114.65,'éƒ‘å·':113.62,'æ­¦æ±‰':114.31,'æˆéƒ½':104.06
        };

        const LUCKY_CONFIG = {
            'æœ¨': { color: 'bg-emerald-500', text: 'é’/ç»¿', icon: 'ğŸª´', item: 'æ¤ç‰©ã€ä¹¦æœ¬' },
            'ç«': { color: 'bg-rose-500',   text: 'çº¢/ç´«', icon: 'ğŸ”¥', item: 'ç”µå­äº§å“ã€ç¯' },
            'åœŸ': { color: 'bg-amber-500',  text: 'é»„/è¤', icon: 'ğŸ§±', item: 'é™¶ç“·ã€ç‰çŸ³' },
            'é‡‘': { color: 'bg-slate-400',  text: 'ç™½/é‡‘', icon: 'ğŸª™', item: 'é‡‘å±é¥°å“' },
            'æ°´': { color: 'bg-blue-500',   text: 'é»‘/è“', icon: 'ğŸ’§', item: 'é¥®æ–™ã€æ°´æ™¶' }
        };

        const GUA_DICT = {
            '111111': {n:'ä¹¾ä¸ºå¤©',d:'å¤§å‰ã€‚åˆšå¥ä¸­æ­£ï¼Œå®œè¿›å–ã€‚'},
            '000000': {n:'å¤ä¸ºåœ°',d:'å‰ã€‚åšå¾·è½½ç‰©ï¼Œå®œåŒ…å®¹åˆä½œã€‚'},
            '100010': {n:'æ°´é›·å±¯',d:'å§‹ç”Ÿä¹‹éš¾ã€‚å®œç§¯æ”’å®åŠ›ï¼Œå‹¿è½»åŠ¨ã€‚'},
            '010001': {n:'å±±æ°´è’™',d:'å¯è’™ä¹‹æ—¶ã€‚å®œè¯·æ•™é•¿è¾ˆã€‚'},
            '111010': {n:'æ°´å¤©éœ€',d:'ç­‰å¾…æ—¶æœºã€‚å‰é€”å…‰æ˜ä½†æœ‰é˜»ç¢ã€‚'},
            '010111': {n:'å¤©æ°´è®¼',d:'äº‰æ‰§ã€‚å‡¡äº‹æ˜“èµ·å£èˆŒï¼Œå®œé€€è®©ã€‚'},
            '000010': {n:'æ°´åœ°æ¯”',d:'äº²å¯†ã€‚åˆ©äºåˆä½œã€äº¤å‹ï¼Œäººç¼˜ä½³ã€‚'},
            '010000': {n:'åœ°æ°´å¸ˆ',d:'å…´å¸ˆã€‚åˆ©äºå›¢é˜Ÿç®¡ç†ï¼Œéœ€çºªå¾‹ã€‚'}
        };

        const STAR_WIKI = {
            'åŒ–ç¦„':'ã€è´¢å¯Œã€‘é¡ºé‚ï¼Œæ”¶è·ã€‚','åŒ–æƒ':'ã€æƒåŠ›ã€‘è¡ŒåŠ¨åŠ›ï¼Œå›ºæ‰§ã€‚','åŒ–ç§‘':'ã€åå£°ã€‘è€ƒè¿ï¼Œè´µäººã€‚','åŒ–å¿Œ':'ã€é˜»ç¢ã€‘çº ç»“ï¼ŒäºæŸã€‚',
            'ç¦„å­˜':'ã€çœŸè´¢ã€‘ç§¯è“„ï¼Œç¨³é‡ã€‚','å¤©é©¬':'ã€å˜åŠ¨ã€‘å¥”æ³¢ï¼Œå‡ºå·®ã€‚','å·¦è¾…':'ã€åŠ©åŠ›ã€‘æœ‹å‹å¸®ã€‚','å³å¼¼':'ã€åŠ©åŠ›ã€‘å¼‚æ€§å¸®ã€‚',
            'å¤©é­':'ã€ææ‹”ã€‘é•¿è¾ˆæœºä¼šã€‚','å¤©é’º':'ã€æœºé‡ã€‘æš—ä¸­å¸®åŠ©ã€‚','æ“ç¾Š':'ã€åˆ‘ä¼¤ã€‘å†²çªï¼Œå¼€æ‹“ã€‚','é™€ç½—':'ã€æ‹–å»¶ã€‘åŸåœ°æ‰“è½¬ã€‚',
            'ç«æ˜Ÿ':'ã€çˆ†å‘ã€‘çªå‘ï¼Œç«çˆ†ã€‚','é“ƒæ˜Ÿ':'ã€æš—äºã€‘éšå¿ï¼Œç®—è®¡ã€‚','åœ°ç©º':'ã€ç ´è€—ã€‘å¾—è€Œå¤å¤±ã€‚','åœ°åŠ«':'ã€æŸå¤±ã€‘åŠé€”è€ŒåºŸã€‚'
        };

        // æµæœˆè¯¦è§£é€»è¾‘åº“
        const MONTHLY_LOGIC = {
            'åŒ–ç¦„': { text: 'è´¢æºå¹¿è¿›ï¼Œå¿ƒæƒ…æ„‰æ‚¦ï¼Œåˆ©äºæŠ•èµ„æˆ–è¡¨ç™½ã€‚', score: 2 },
            'åŒ–æƒ': { text: 'æŒæƒå‡èŒï¼Œè™½ç„¶å¿™ç¢Œä½†æœ‰æˆå°±æ„Ÿã€‚', score: 1.5 },
            'åŒ–ç§‘': { text: 'åå£°åœ¨å¤–ï¼Œè€ƒè¯•é¡ºåˆ©ï¼Œæœ‰è´µäººèµè¯†ã€‚', score: 1.5 },
            'åŒ–å¿Œ': { text: 'è¯¸äº‹ä¸é¡ºï¼Œå°å¿ƒå£èˆŒæ˜¯éï¼Œåˆ‡å‹¿å†²åŠ¨ã€‚', score: -3 },
            'ç¦„å­˜': { text: 'è´¢è¿ç¨³å¥ï¼Œé€‚åˆå­˜é’±ï¼Œåšäº‹ç¨³æ‰ç¨³æ‰“ã€‚', score: 1 },
            'å¤©é©¬': { text: 'å¥”æ³¢åŠ³ç¢Œï¼Œé€‚åˆå‡ºå·®ã€æ—…æ¸¸æˆ–å˜åŠ¨å·¥ä½œã€‚', score: 0.5 },
            'å·¦è¾…': { text: 'å¾—é“å¤šåŠ©ï¼Œå·¥ä½œä¸Šæœ‰äººå¸®å¿™ï¼Œäº‹åŠåŠŸå€ã€‚', score: 1 },
            'å³å¼¼': { text: 'äººç¼˜æä½³ï¼Œå¼‚æ€§ç¼˜å¥½ï¼Œå®¹æ˜“è·å¾—å¸®åŠ©ã€‚', score: 1 },
            'å¤©é­': { text: 'æœ‰é•¿è¾ˆæˆ–ä¸Šå¸ææ‹”ï¼Œæœºä¼šè‡ªåŠ¨æ‰¾ä¸Šé—¨ã€‚', score: 1 },
            'å¤©é’º': { text: 'æš—ä¸­æœ‰äººç›¸åŠ©ï¼Œé€¢å‡¶åŒ–å‰ï¼Œæœºé‡ä¸é”™ã€‚', score: 1 },
            'æ“ç¾Š': { text: 'å®¹æ˜“å—ä¼¤æˆ–èµ·äº‰æ‰§ï¼Œå¼€è½¦è¿åŠ¨éœ€å°å¿ƒã€‚', score: -1.5 },
            'é™€ç½—': { text: 'è¿›åº¦ç¼“æ…¢ï¼Œå†…å¿ƒçº ç»“ï¼Œäº‹æƒ…å®¹æ˜“æ‹–å»¶ã€‚', score: -1.5 },
            'ç«æ˜Ÿ': { text: 'çªå‘çŠ¶å†µå¤šï¼Œè„¾æ°”ç«çˆ†ï¼Œå°å¿ƒæ„å¤–ç ´è´¢ã€‚', score: -1.5 },
            'é“ƒæ˜Ÿ': { text: 'å¿ƒé‡Œæ†‹å±ˆï¼Œåƒå“‘å·´äºï¼Œé˜²å°äººç®—è®¡ã€‚', score: -1.5 },
            'åœ°ç©º': { text: 'è´¢æ¥è´¢å»ï¼Œå®¹æ˜“ä¹°æ— ç”¨çš„ä¸œè¥¿ï¼Œæ€ç»ªé£˜å¿½ã€‚', score: -1 },
            'åœ°åŠ«': { text: 'å°å¿ƒè¢«æˆªèƒ¡ï¼Œä¸œè¥¿ä¸¢å¤±ï¼ŒæŠ•èµ„éœ€æå…¶è°¨æ…ã€‚', score: -1 }
        };

        window.onload = function() {
            initDateSelectors();
            setTimeout(calculateAll, 500);
        };

        function initDateSelectors() {
            const y = document.getElementById('selYear');
            const m = document.getElementById('selMonth');
            const d = document.getElementById('selDay');

            for (let i = new Date().getFullYear(); i >= 1930; i--) {
                y.add(new Option(i + 'å¹´', i));
            }
            y.value = 1990;

            for (let i = 1; i <= 12; i++) {
                m.add(new Option(i + 'æœˆ', i));
            }

            const upd = () => {
                const days = new Date(y.value, m.value, 0).getDate();
                d.innerHTML = '';
                for (let i = 1; i <= days; i++) {
                    d.add(new Option(i + 'æ—¥', i));
                }
            };
            y.onchange = upd;
            m.onchange = upd;
            upd();
        }

        function switchTab(tab) {
            document.getElementById('view-daily').classList.toggle('hidden', tab !== 'daily');
            document.getElementById('view-ziwei').classList.toggle('hidden', tab !== 'ziwei');

            document.getElementById('btn-daily').className =
                tab === 'daily'
                    ? 'tab-btn active flex-1 py-3 cursor-pointer text-sm'
                    : 'tab-btn flex-1 py-3 cursor-pointer text-sm';

            document.getElementById('btn-ziwei').className =
                tab === 'ziwei'
                    ? 'tab-btn active flex-1 py-3 cursor-pointer text-sm'
                    : 'tab-btn flex-1 py-3 cursor-pointer text-sm';
        }

        function calculateAll() {
            if (typeof Lunar === 'undefined' || typeof iztro === 'undefined') {
                alert("æ ¸å¿ƒåº“æ­£åœ¨åŠ è½½...");
                return;
            }
            const by = document.getElementById('selYear').value;
            const bm = document.getElementById('selMonth').value;
            const bd = document.getElementById('selDay').value;
            const bh = document.getElementById('birthTime').value;
            const gender = document.getElementById('gender').value;
            const [hour, minute] = bh.split(':').map(Number);

            const solarBirth = Solar.fromYmdHms(
                parseInt(by), parseInt(bm), parseInt(bd),
                hour, minute, 0
            );

            renderDailyFortune(solarBirth.getLunar().getDayGan());
            renderZiweiChart(solarBirth, gender);
        }

        function renderDailyFortune(userDayGan) {
            const today = new Date();
            const lunarToday = Lunar.fromDate(today);

            document.getElementById('dailyDate').innerText =
                `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.getElementById('dailyLunar').innerText =
                `å†œå†${lunarToday.getMonthInChinese()}æœˆ${lunarToday.getDayInChinese()}`;
            document.getElementById('dailyGanzhi').innerText =
                `${lunarToday.getYearInGanZhi()}å¹´ ${lunarToday.getDayInGanZhi()}æ—¥`;
            document.getElementById('dailyNayin').innerText = lunarToday.getDayNaYin();

            let userElement = '';
            if (['ç”²','ä¹™'].includes(userDayGan)) userElement = 'æœ¨';
            else if (['ä¸™','ä¸'].includes(userDayGan)) userElement = 'ç«';
            else if (['æˆŠ','å·±'].includes(userDayGan)) userElement = 'åœŸ';
            else if (['åºš','è¾›'].includes(userDayGan)) userElement = 'é‡‘';
            else userElement = 'æ°´';

            document.getElementById('userDayMaster').innerText =
                `æ—¥ä¸»: ${userDayGan}${userElement}`;

            const config = LUCKY_CONFIG[userElement];
            document.getElementById('luckyColorDot').className =
                `w-12 h-12 rounded-full shadow-inner border-4 border-white ring-1 ring-slate-200 mb-1 ${config.color}`;
            document.getElementById('luckyColorText').innerText = config.text;
            document.getElementById('luckyItemIcon').innerText = config.icon;
            document.getElementById('luckyItemText').innerText = config.item;

            const yi = lunarToday.getDayYi();
            const ji = lunarToday.getDayJi();
            document.getElementById('almanac-yi').innerHTML =
                yi.slice(0, 6).map(t =>
                    `<span class="text-xs bg-slate-50 text-slate-600 border border-slate-200 px-1.5 py-0.5 rounded">${t}</span>`
                ).join('');
            document.getElementById('almanac-ji').innerHTML =
                ji.slice(0, 6).map(t =>
                    `<span class="text-xs bg-slate-50 text-slate-600 border border-slate-200 px-1.5 py-0.5 rounded">${t}</span>`
                ).join('');

            const y = today.getFullYear();
            const m = today.getMonth() + 1;
            const d = today.getDate();
            const sum = y + m + d;
            renderGua(sum % 8 || 8, (sum + d) % 8 || 8);
        }

        function renderGua(upper, lower) {
            const BAGUA_BIN  = [null, '111','011','101','001','110','010','100','000'];
            const BAGUA_NAME = [null, 'ä¹¾','å…‘','ç¦»','éœ‡','å·½','å','è‰®','å¤'];

            const bin  = BAGUA_BIN[upper] + BAGUA_BIN[lower];
            const info = GUA_DICT[bin] || {
                n: `${BAGUA_NAME[upper]}ä¸Š${BAGUA_NAME[lower]}ä¸‹`,
                d: 'å¹³ç¨³ä¹‹è±¡ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚'
            };

            document.getElementById('gua-name').innerText = info.n;
            document.getElementById('gua-desc').innerText = info.d;

            const container = document.getElementById('gua-lines');
            container.innerHTML = '';
            for (let char of bin) {
                const line = document.createElement('div');
                line.className = "h-1 w-full rounded-sm mb-[3px]";
                if (char === '1') {
                    line.style.backgroundColor = '#334155';
                } else {
                    line.innerHTML =
                        '<div class="flex justify-between h-full">' +
                        '<span class="w-[42%] h-full bg-slate-700 rounded-sm"></span>' +
                        '<span class="w-[42%] h-full bg-slate-700 rounded-sm"></span>' +
                        '</div>';
                }
                container.appendChild(line);
            }
        }

        function renderZiweiChart(solar, gender) {
            const location = document.getElementById('location').value || '';
            let long = 120;
            for (let k in CITY_LONGITUDES) {
                if (location.includes(k)) {
                    long = CITY_LONGITUDES[k];
                    break;
                }
            }
            const offset = (long - 120) * 4;

            const dateStr = solar.toYmd();
            const fixDate = new Date(
                solar.getYear(), solar.getMonth() - 1, solar.getDay(),
                solar.getHour(), solar.getMinute()
            );
            fixDate.setMinutes(fixDate.getMinutes() + offset);
            const hourIndex = Math.floor((fixDate.getHours() + 1) / 2) % 12;

            try {
                const astrolabe = iztro.astro.bySolar(dateStr, hourIndex, gender, true, 'zh-CN');
                const container = document.getElementById('ziwei-result');
                container.innerHTML = '';

                const today = new Date();
                for (let i = 0; i < 3; i++) {
                    let tDate = new Date(today.getFullYear(), today.getMonth() + i, 15);
                    let tStr = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2,'0')}-15 12:00:00`;
                    const scope = astrolabe.horoscope(tStr);
                    if (!scope) continue;

                    const pName = astrolabe.palace(scope.monthly.index).name;

                    // æå–æ˜Ÿæ›œå¹¶è®¡ç®—åˆ†æ•°
                    let stars = [];
                    let totalScore = 0;
                    let mainDesc = "æœ¬æœˆè¿åŠ¿å¹³ç¨³ï¼ŒæŒ‰éƒ¨å°±ç­å³å¯ã€‚";

                    [scope.monthly.index, (scope.monthly.index + 4) % 12, (scope.monthly.index + 8) % 12]
                        .forEach(idx => {
                            const p = astrolabe.palace(idx);
                            [...p.majorStars, ...p.minorStars].forEach(s => {
                                stars.push(s.name);

                                let logic = null;
                                if (s.mutagen && MONTHLY_LOGIC['åŒ–' + s.mutagen]) {
                                    logic = MONTHLY_LOGIC['åŒ–' + s.mutagen];
                                    mainDesc = logic.text;
                                } else if (MONTHLY_LOGIC[s.name]) {
                                    logic = MONTHLY_LOGIC[s.name];
                                    if (!mainDesc.includes("åŒ–")) {
                                        mainDesc = logic.text;
                                    }
                                }
                                if (logic) totalScore += logic.score;
                            });
                        });

                    // è¯„åˆ†æ ·å¼
                    let scoreHtml = '';
                    const starCount = Math.max(1, Math.min(5, Math.floor(3 + totalScore)));
                    for (let k = 0; k < 5; k++) {
                        scoreHtml += k < starCount ? 'â˜…' : 'â˜†';
                    }

                    let themeColor = totalScore >= 1
                        ? 'text-orange-500'
                        : (totalScore <= -1 ? 'text-slate-500' : 'text-indigo-500');
                    let cardBg = totalScore >= 1
                        ? 'bg-orange-50/50 border-orange-100'
                        : (totalScore <= -1 ? 'bg-slate-50 border-slate-200' : 'bg-indigo-50/50 border-indigo-100');

                    const good = stars.filter(n =>
                        ['åŒ–ç¦„','åŒ–æƒ','åŒ–ç§‘','ç¦„å­˜','å¤©é©¬','å·¦è¾…','å³å¼¼','å¤©é­','å¤©é’º'].some(k => n.includes(k))
                    ).slice(0, 4);

                    const bad = stars.filter(n =>
                        ['åŒ–å¿Œ','æ“ç¾Š','é™€ç½—','ç«æ˜Ÿ','é“ƒæ˜Ÿ','åœ°ç©º','åœ°åŠ«'].some(k => n.includes(k))
                    ).slice(0, 4);

                    const html = `
                        <div class="rounded-2xl p-5 border shadow-sm ${cardBg} transition hover:shadow-md">
                            <div class="flex justify-between items-center mb-3 border-b border-black/5 pb-2">
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">${tDate.getFullYear()}å¹´${tDate.getMonth() + 1}æœˆ</h3>
                                    <p class="text-xs text-slate-500">æµæœˆåœ¨ã€${pName}ã€‘</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm ${themeColor} tracking-widest">${scoreHtml}</div>
                                    <div class="text-[10px] text-slate-400 font-bold mt-0.5">
                                        ${totalScore >= 1 ? 'è¿åŠ¿å¼ºåŠ²' : (totalScore <= -1 ? 'éœ€è°¨æ…' : 'å¹³ç¨³')}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <p class="text-sm text-slate-700 leading-relaxed font-medium">ğŸ’¡ é‡ç‚¹ï¼š${mainDesc}</p>
                            </div>

                            <div class="flex flex-col gap-2">
                                <div class="flex items-center bg-white/60 rounded px-2 py-1.5">
                                    <span class="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 rounded mr-2 font-bold">å‰</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${
                                            good.length
                                                ? good.map(s =>
                                                    `<span class="text-xs text-slate-600 cursor-pointer hover:text-indigo-600 hover:underline" onclick="showExplain('${s}')">${s}</span>`
                                                  ).join(' ')
                                                : '<span class="text-xs text-slate-300">-</span>'
                                        }
                                    </div>
                                </div>
                                <div class="flex items-center bg-white/60 rounded px-2 py-1.5">
                                    <span class="text-[10px] bg-rose-100 text-rose-700 px-1.5 rounded mr-2 font-bold">å‡¶</span>
                                    <div class="flex flex-wrap gap-1">
                                        ${
                                            bad.length
                                                ? bad.map(s =>
                                                    `<span class="text-xs text-slate-600 cursor-pointer hover:text-indigo-600 hover:underline" onclick="showExplain('${s}')">${s}</span>`
                                                  ).join(' ')
                                                : '<span class="text-xs text-slate-300">-</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('ziwei-result').innerHTML =
                    '<div class="text-center text-red-500 text-sm">æ’ç›˜å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°</div>';
            }
        }

        function showExplain(name) {
            const key = Object.keys(STAR_WIKI).find(k => name.includes(k));
            if (key) {
                document.getElementById('modalTitle').innerText = key;
                document.getElementById('modalDesc').innerText  = STAR_WIKI[key];
                document.getElementById('explainModal').classList.remove('hidden');
            }
        }

        function closeModal() {
            document.getElementById('explainModal').classList.add('hidden');
        }
    </script>
</body>
</html>
